<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Club '98 - Baza Danych</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="desktop-wallpaper">
        <header class="window-header">
            <div class="window-title">üíø Panel Administratora (Baza Danych)</div>
            <div class="window-controls">
                <button class="control-btn minimize">-</button>
                <button class="control-btn maximize">‚òê</button>
                <button class="control-btn close">X</button>
            </div>
        </header>

        <nav class="desktop-icons">
            <a href="index.html" class="icon-link">
                <img src="https://i.imgur.com/8QZ3q7F.png" alt="Ikonka DVD" class="icon-img">
                <span class="icon-text">G≈Ç√≥wna</span>
            </a>
            <a href="statystyki.html" class="icon-link">
                <img src="https://i.imgur.com/KzR3F0S.png" alt="Ikonka folderu" class="icon-img">
                <span class="icon-text">Baza Danych</span>
            </a>
            <a href="wykresy.html" class="icon-link">
                <img src="https://i.imgur.com/5E6XwF2.png" alt="Ikonka Wykresu" class="icon-img">
                <span class="icon-text">Wykresy.html</span>
            </a>
        </nav>

        <main class="main-window">
            <div class="window-body">
                <div class="start-menu-bar">
                    <span class="start-text">START</span>
                    <span class="menu-item active">Plik</span>
                    <span class="menu-item">Narzƒôdzia</span>
                    <span class="menu-item">Pomoc</span>
                </div>
                
                <div class="content">
                    <h1>üíæ Import Danych (Backend)</h1>
                    <p>Witaj w panelu administracyjnym. Tutaj wgrasz plik XLSX z danymi wypo≈ºycze≈Ñ. Dane zostanƒÖ zapisane w pamiƒôci lokalnej i wy≈õwietlone na stronie "Wykresy".</p>
                    
                    <div class="featured-block">
                        <div style="width: 100%;">
                            <h2>1. Wczytaj plik</h2>
                            <div class="dashboard-controls">
                                <label for="xlsx-file" class="classic-button">üìÇ Otw√≥rz plik Excel...</label>
                                <input type="file" id="xlsx-file" accept=".xlsx, .xls" style="display: none;">
                                <button id="clear-data-btn" class="classic-button" style="color: red;">üóëÔ∏è Formatuj dysk (Wyczy≈õƒá)</button>
                            </div>
                            
                            <div id="status-display" class="status-bar" style="margin-top: 10px;">
                                Status: Oczekiwanie na dyskietkƒô...
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h2>2. PodglƒÖd surowych danych</h2>
                        <div class="retro-table-container">
                            <table class="retro-table" id="preview-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Info</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Brak danych</td>
                                        <td>Wgraj plik XLSX, aby zobaczyƒá podglƒÖd.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="example-data-info">
                        <h3>Wymagany format Excela:</h3>
                        <p>Kolumny: <b>Tytu≈Ç</b>, <b>Gatunek</b>, <b>Liczba Wypo≈ºycze≈Ñ</b>, <b>Rok Produkcji</b></p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="taskbar">
            <div class="taskbar-start-button">START</div>
            <div class="taskbar-item active">üíæ Baza Danych</div>
            <div class="taskbar-clock" id="clock">12:00 PM</div>
        </footer>
    </div>
    
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const XLSX_KEY = 'videoClubStats';
            const fileInput = document.getElementById('xlsx-file');
            const statusDisplay = document.getElementById('status-display');
            const previewTable = document.getElementById('preview-table');
            const clearDataBtn = document.getElementById('clear-data-btn');

            function renderPreviewTable(data) {
                if (!data || data.length === 0) {
                    previewTable.innerHTML = '<thead><tr><th>Info</th></tr></thead><tbody><tr><td>Brak danych w pamiƒôci.</td></tr></tbody>';
                    return;
                }
                
                // Tworzenie nag≈Ç√≥wk√≥w dynamicznie z kluczy pierwszego obiektu
                const headers = Object.keys(data[0]);
                let thead = '<thead><tr>';
                headers.forEach(h => thead += `<th>${h}</th>`);
                thead += '</tr></thead>';

                // Tworzenie wierszy (max 50 dla podglƒÖdu)
                let tbody = '<tbody>';
                data.slice(0, 50).forEach(row => {
                    tbody += '<tr>';
                    headers.forEach(h => tbody += `<td>${row[h] || ''}</td>`);
                    tbody += '</tr>';
                });
                tbody += '</tbody>';

                previewTable.innerHTML = thead + tbody;
            }

            // Wczytanie danych przy starcie
            const storedData = localStorage.getItem(XLSX_KEY);
            if (storedData) {
                const parsed = JSON.parse(storedData);
                statusDisplay.textContent = `W pamiƒôci: ${parsed.length} rekord√≥w.`;
                renderPreviewTable(parsed);
            }

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                statusDisplay.textContent = 'Czytanie dyskietki...';
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if(json.length > 0) {
                            localStorage.setItem(XLSX_KEY, JSON.stringify(json));
                            statusDisplay.textContent = `SUKCES! Zapisano ${json.length} rekord√≥w. Przejd≈∫ do zak≈Çadki Wykresy.`;
                            renderPreviewTable(json);
                            alert("Dane za≈Çadowane poprawnie! Mo≈ºesz teraz otworzyƒá stronƒô WYKRESY.");
                        } else {
                            statusDisplay.textContent = 'B≈ÇƒÖd: Pusty plik.';
                        }
                    } catch (err) {
                        statusDisplay.textContent = 'B≈ÇƒÖd odczytu pliku.';
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            clearDataBtn.addEventListener('click', () => {
                if(confirm("Czy na pewno chcesz skasowaƒá bazƒô danych?")) {
                    localStorage.removeItem(XLSX_KEY);
                    statusDisplay.textContent = 'Baza danych wyczyszczona.';
                    renderPreviewTable([]);
                }
            });
        });
    </script>
</body>
</html>