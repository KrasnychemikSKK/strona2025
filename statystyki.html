<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Club '98 - Statystyki Wypo≈ºycze≈Ñ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="desktop-wallpaper">
        <header class="window-header">
            <div class="window-title">üìä Statystyki Wypo≈ºycze≈Ñ</div>
            <div class="window-controls">
                <button class="control-btn minimize">-</button>
                <button class="control-btn maximize">‚òê</button>
                <button class="control-btn close">X</button>
            </div>
        </header>

        <nav class="desktop-icons">
            <a href="index.html" class="icon-link">
                <img src="https://i.imgur.com/8QZ3q7F.png" alt="Ikonka DVD" class="icon-img">
                <span class="icon-text">G≈Ç√≥wna</span>
            </a>
            <a href="katalog.html" class="icon-link">
                <img src="https://i.imgur.com/KzR3F0S.png" alt="Ikonka folderu" class="icon-img">
                <span class="icon-text">Katalog.html</span>
            </a>
            <a href="kontakt.html" class="icon-link">
                <img src="https://i.imgur.com/5E6XwF2.png" alt="Ikonka wiadomo≈õci" class="icon-img">
                <span class="icon-text">Kontakt.txt</span>
            </a>
            <a href="statystyki.html" class="icon-link">
                <img src="https://i.imgur.com/8QZ3q7F.png" alt="Ikonka Wykresu" class="icon-img icon-chart">
                <span class="icon-text">Statystyki.html</span>
            </a>
        </nav>

        <main class="main-window">
            <div class="window-body">
                <div class="start-menu-bar">
                    <span class="start-text">START</span>
                    <span class="menu-item active">Plik</span>
                    <span class="menu-item">Edycja</span>
                    <span class="menu-item">Pomoc</span>
                </div>
                
                <div class="content">
                    <h1>üìä Dashboard Statystyk</h1>
                    <p>Wczytaj plik XLSX z danymi, aby zobaczyƒá aktualne statystyki wypo≈ºycze≈Ñ. Dane zostanƒÖ zapisane w pamiƒôci przeglƒÖdarki.</p>
                    
                    <div class="dashboard-controls">
                        <label for="xlsx-file" class="classic-button">Wybierz plik XLSX...</label>
                        <input type="file" id="xlsx-file" accept=".xlsx, .xls" style="display: none;">
                        <button id="clear-data-btn" class="classic-button">Wyczy≈õƒá dane</button>
                    </div>

                    <div id="status-display" class="status-bar" style="margin-top: 20px;">
                        <span id="data-count">0</span> rekord√≥w w pamiƒôci | 
                        <span id="data-status">Gotowy do importu</span>
                    </div>

                    <div id="stats-display" class="featured-block dashboard-grid">
                        <h2>Brak danych</h2>
                        <p>Zaimportuj plik XLSX, aby zobaczyƒá statystyki wypo≈ºycze≈Ñ.</p>
                    </div>

                    <div class="example-data-info">
                        <h3>Oczekiwana struktura pliku XLSX:</h3>
                        <p>Plik powinien zawieraƒá kolumny: **Tytu≈Ç**, **Gatunek**, **Liczba Wypo≈ºycze≈Ñ**, **Rok Produkcji**.</p>
                        <p>Mo≈ºesz u≈ºyƒá przyk≈Çadowych danych do testu:</p>
                        <textarea id="example-data" rows="5" readonly>Tytu≈Ç,Gatunek,Liczba Wypo≈ºycze≈Ñ,Rok Produkcji
Kosmiczne Wyprawy,Sci-Fi,150,1997
Mroczny Detektyw,Thriller,95,1995
VHS Komedia,Komedia,210,1999
Kresk√≥wka '98,Animacja,180,1998
Wielki Wy≈õcig,Akcja,120,1996</textarea>
                    </div>
                </div>
            </div>
        </main>

        <footer class="taskbar">
            <div class="taskbar-start-button">
                START
            </div>
            <div class="taskbar-item active">
                üìä Statystyki Wypo≈ºycze≈Ñ
            </div>
            <div class="taskbar-clock" id="clock">
                12:00 PM
            </div>
        </footer>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Ta sekcja powinna znale≈∫ƒá siƒô na ko≈Ñcu pliku script.js, ale dla wygody dodajemy jƒÖ bezpo≈õrednio do statystyki.html
        // w celu oddzielenia logiki statystyk od g≈Ç√≥wnej logiki strony
        document.addEventListener('DOMContentLoaded', () => {
            const XLSX_KEY = 'videoClubStats';
            const fileInput = document.getElementById('xlsx-file');
            const statusDisplay = document.getElementById('data-status');
            const dataCountDisplay = document.getElementById('data-count');
            const statsDisplay = document.getElementById('stats-display');
            const clearDataBtn = document.getElementById('clear-data-btn');

            // --- 1. Obs≈Çuga Wczytywania Pliku XLSX ---
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                statusDisplay.textContent = 'Wczytywanie...';

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Zak≈Çadamy, ≈ºe interesuje nas pierwszy arkusz
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Konwersja arkusza na JSON (tablicƒô obiekt√≥w)
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        // Walidacja i czyszczenie danych (prosta)
                        const requiredFields = ['Tytu≈Ç', 'Gatunek', 'Liczba Wypo≈ºycze≈Ñ', 'Rok Produkcji'];
                        const cleanedData = json.filter(item => 
                            requiredFields.every(field => item.hasOwnProperty(field))
                        );

                        if (cleanedData.length === 0) {
                             statusDisplay.textContent = 'B≈ÅƒÑD: Brak rekord√≥w z wymaganymi kolumnami.';
                             renderStats([]);
                             return;
                        }

                        // Zapis do localStorage
                        localStorage.setItem(XLSX_KEY, JSON.stringify(cleanedData));
                        statusDisplay.textContent = `Pomy≈õlnie za≈Çadowano ${cleanedData.length} rekord√≥w.`;
                        renderStats(cleanedData);

                    } catch (error) {
                        console.error('B≈ÇƒÖd parsowania XLSX:', error);
                        statusDisplay.textContent = 'B≈ÅƒÑD: Nie uda≈Ço siƒô przetworzyƒá pliku XLSX.';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- 2. Obs≈Çuga Czyszczenia Danych ---
            clearDataBtn.addEventListener('click', () => {
                localStorage.removeItem(XLSX_KEY);
                statusDisplay.textContent = 'Dane zosta≈Çy wyczyszczone.';
                renderStats([]);
            });

            // --- 3. Funkcje Analityczne i Renderowanie Dashboardu ---
            
            function calculateStats(data) {
                if (data.length === 0) {
                    return null;
                }

                // A. Total Wypo≈ºycze≈Ñ
                const totalWypozyczen = data.reduce((sum, item) => sum + (parseInt(item['Liczba Wypo≈ºycze≈Ñ']) || 0), 0);

                // B. Top 3 Gatunki
                const genreCounts = data.reduce((acc, item) => {
                    const genre = item['Gatunek'] || 'Nieznany';
                    const rentals = parseInt(item['Liczba Wypo≈ºycze≈Ñ']) || 0;
                    acc[genre] = (acc[genre] || 0) + rentals;
                    return acc;
                }, {});

                const topGenres = Object.entries(genreCounts)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 3);
                
                // C. Najczƒô≈õciej Wypo≈ºyczany Film
                const topMovie = data.reduce((top, item) => {
                    const rentals = parseInt(item['Liczba Wypo≈ºe≈Ñ']) || 0;
                    if (rentals > (top.rentals || 0)) {
                        return { title: item['Tytu≈Ç'], rentals: rentals, genre: item['Gatunek'] };
                    }
                    return top;
                }, {});

                return {
                    totalWypozyczen,
                    topGenres,
                    topMovie
                };
            }

            function renderStats(data) {
                const stats = calculateStats(data);
                dataCountDisplay.textContent = data.length;
                statsDisplay.innerHTML = ''; // Wyczy≈õƒá poprzednie statystyki

                if (!stats) {
                    statsDisplay.innerHTML = '<h2>Brak danych</h2><p>Zaimportuj plik XLSX, aby zobaczyƒá statystyki wypo≈ºycze≈Ñ.</p>';
                    return;
                }

                // Zgodnie ze stylem Windows 98, u≈ºyjemy prostych blok√≥w i tekstu.
                
                const totalBlock = `
                    <div class="stat-box">
                        <div class="stat-label">Ca≈Çkowita Liczba Wypo≈ºycze≈Ñ:</div>
                        <div class="stat-value">${stats.totalWypozyczen}</div>
                    </div>
                `;

                const topGenresBlock = `
                    <div class="stat-box">
                        <div class="stat-label">TOP 3 Gatunki (wg. Wypo≈ºycze≈Ñ):</div>
                        <ol class="stat-list">
                            ${stats.topGenres.map(([genre, count]) => 
                                `<li>**${genre}**: ${count} wypo≈ºycze≈Ñ</li>`
                            ).join('')}
                        </ol>
                    </div>
                `;

                const topMovieBlock = stats.topMovie.title ? `
                    <div class="stat-box">
                        <div class="stat-label">MEGA HIT TYGODNIA:</div>
                        <p class="movie-hit">**${stats.topMovie.title}**</p>
                        <p class="movie-info">Gatunek: ${stats.topMovie.genre}</p>
                        <p class="movie-info">Wypo≈ºycze≈Ñ: ${stats.topMovie.rentals}</p>
                    </div>
                ` : '';

                statsDisplay.innerHTML = `
                    <div class="dashboard-section">
                        ${totalBlock}
                    </div>
                    <div class="dashboard-section">
                        ${topGenresBlock}
                    </div>
                    <div class="dashboard-section">
                        ${topMovieBlock}
                    </div>
                `;

                // Po za≈Çadowaniu strony, sprawd≈∫ i za≈Çaduj dane z localStorage
                const storedData = localStorage.getItem(XLSX_KEY);
                if (storedData) {
                    try {
                        const parsedData = JSON.parse(storedData);
                        renderStats(parsedData);
                        statusDisplay.textContent = `Za≈Çadowano ${parsedData.length} rekord√≥w z pamiƒôci.`;
                    } catch (e) {
                        localStorage.removeItem(XLSX_KEY);
                        statusDisplay.textContent = 'B≈ÅƒÑD: Uszkodzone dane w pamiƒôci.';
                        renderStats([]);
                    }
                } else {
                    renderStats([]);
                }
            }

            // Inicjalizacja: Wczytaj dane przy starcie
            const storedData = localStorage.getItem(XLSX_KEY);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    renderStats(parsedData);
                    statusDisplay.textContent = `Za≈Çadowano ${parsedData.length} rekord√≥w z pamiƒôci.`;
                } catch (e) {
                    localStorage.removeItem(XLSX_KEY);
                    statusDisplay.textContent = 'B≈ÅƒÑD: Uszkodzone dane w pamiƒôci.';
                    renderStats([]);
                }
            } else {
                renderStats([]);
            }
        });
    </script>
</body>
</html>